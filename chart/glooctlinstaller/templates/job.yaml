{{- if .Values.marketplaceResources }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-install-values
  namespace: {{ .Release.Namespace }}
data:
  "marketplace.yaml": >-
    gloo:
      deployment:
        image:
          registry: {{ .Values.glooImages.gloo.registry }}
          repository: {{ .Values.glooImages.gloo.repository }}
          tag: {{ .Values.glooImages.gloo.tag }}
    discovery:
      deployment:
        image:
          registry: {{ .Values.glooImages.discovery.registry }}
          repository: {{ .Values.glooImages.discovery.repository }}
          tag: {{ .Values.glooImages.discovery.tag }}
    gateway:
      deployment:
        image:
          registry: {{ .Values.glooImages.gateway.registry }}
          repository: {{ .Values.glooImages.gateway.repository }}
          tag: {{ .Values.glooImages.gateway.tag }}
      certGenJob:
        image:
          registry: {{ .Values.glooImages.certgen.registry }}
          repository: {{ .Values.glooImages.certgen.repository }}
          tag: {{ .Values.glooImages.certgen.tag }}
    accessLogger:
      deployment:
        image:
          registry: {{ .Values.glooImages.accessLogger.registry }}
          repository: {{ .Values.glooImages.accessLogger.repository }}
          tag: {{ .Values.glooImages.accessLogger.tag }}
    gatewayProxies:
      gatewayProxy:
        podTemplate:
          image:
            registry: {{ .Values.glooImages.glooEnvoyWrapper.registry }}
            repository: {{ .Values.glooImages.glooEnvoyWrapper.repository }}
            tag: {{ .Values.glooImages.glooEnvoyWrapper.tag }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-gloo-installer
  namespace: {{ .Release.Namespace }}
spec:
  template:
    spec:
      serviceAccount: {{ .Values.glooctlServiceAccount }}
      containers:
      - name: glooctl-installer
        image: {{ .Values.glooctlInstaller.image.full }}
        imagePullPolicy: Always
        command: 
          - "glooctl"
          - "install"
          - "gateway"
          {{- if .Values.enterpriseLicense }}
          - "enterprise"
          - "--license-key"
          - {{ .Values.enterpriseLicense }}
          - "--file"
          - "/var/gloo/gloo-ee-1.1.0.tgz"
          {{- else }} # enterpriseLicense
          - "--file"
          - "/var/gloo/gloo-1.1.0.tgz"
          {{- end }} # enterpriseLicense
          - "--namespace"
          - {{ .Release.Namespace }}
          - "--values"
          - /var/gloo/install-values/marketplace.yaml
        volumeMounts:
          - name: values-volume
            mountPath: /var/gloo/install-values
      volumes:
        - name: values-volume
          configMap:
            name: {{ .Release.Name }}-install-values
            items:
            - key: "marketplace.yaml"
              path: "marketplace.yaml"
      restartPolicy: Never
  backoffLimit: 4
{{- end }} # marketplaceResources
